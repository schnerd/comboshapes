var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(g){return g.raw=g};$jscomp.createTemplateTagFirstArgWithRaw=function(g,m){g.raw=m;return g};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(g,m,q){g!=Array.prototype&&g!=Object.prototype&&(g[m]=q.value)};
$jscomp.getGlobal=function(g){g=["object"==typeof globalThis&&globalThis,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,g];for(var m=0;m<g.length;++m){var q=g[m];if(q&&q.Math==Math)return q}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(g,m,q,l){if(m){q=$jscomp.global;g=g.split(".");for(l=0;l<g.length-1;l++){var t=g[l];t in q||(q[t]={});q=q[t]}g=g[g.length-1];l=q[g];m=m(l);m!=l&&null!=m&&$jscomp.defineProperty(q,g,{configurable:!0,writable:!0,value:m})}};$jscomp.owns=function(g,m){return Object.prototype.hasOwnProperty.call(g,m)};$jscomp.polyfill("Object.values",function(g){return g?g:function(g){var m=[],l;for(l in g)$jscomp.owns(g,l)&&m.push(g[l]);return m}},"es8","es3");
(function(g,m,q){function l(a){this.game=a;this.visible=!0;this.rotationVelocity=this.yVelocity=this.xVelocity=this.rotation=this.h=this.w=this.y=this.x=0;this.initTime=Date.now();this.lastPositionUpdateTime=0}function t(a,b){l.call(this,a);this.title=b;this.buttons=[];this.visible=!1}function x(a,b,c){l.call(this,a);this.text=b;this.callback=c;this.fontColor="#fff";this.backgroundColor="#539"}function v(a){l.call(this,a);this.cards=[];this.cardHashes={};this.finishedCards=[];this._numValidSets=-1}
function r(a){l.call(this,a);this.animationPercent=this.countNum=this.patternNum=this.shapeNum=this.colorNum=0;this.accepted=this.selected=!1;this.perturbCoords=[];this.setCardConfig({colorNum:3*Math.random()>>0,shapeNum:3*Math.random()>>0,patternNum:3*Math.random()>>0,countNum:3*Math.random()>>0})}var E=function(a,b){var c=function(){};c.prototype=b.prototype;a.prototype=new c;a.prototype.constructor=a},ia=function(a,b,c){for(var e=a.length-1;0<=e;e--)if(a[e].visible&&a[e].containsCoord(b,c))return a[e].click(b,
c),!0;return!1},z=function(a,b,c,e){a.beginPath();a.arc(b,c,e,0,2*Math.PI);a.fill()},G=function(a,b,c,e){a.beginPath();a.arc(b,c,e,0,2*Math.PI);a.stroke()},y=function(a,b,c,e,f,d){e&&f&&((d=d||0)?(a.beginPath(),a.moveTo(b+d,c),a.lineTo(b+e-d,c),a.quadraticCurveTo(b+e,c,b+e,c+d),a.lineTo(b+e,c+f-d),a.quadraticCurveTo(b+e,c+f,b+e-d,c+f),a.lineTo(b+d,c+f),a.quadraticCurveTo(b,c+f,b,c+f-d),a.lineTo(b,c+d),a.quadraticCurveTo(b,c,b+d,c),a.closePath(),a.fill()):a.fillRect(b,c,e,f))},J=function(a,b,c,e,f,
d,h){a.save();a.fillStyle=d;a.font=e+"px "+f;a.textAlign="center";a.textBaseline="top";a.fillText(h,b,c-e/2);a.restore()};l.prototype={setCoords:function(a,b,c,e){this.x=a;this.y=b;this.w=c;this.h=e},updateMotion:function(){var a=Date.now(),b=(a-this.lastPositionUpdateTime)/1E3;this.x+=this.xVelocity*b;this.y+=this.yVelocity*b;this.rotation+=this.rotationVelocity*b;this.lastPositionUpdateTime=a},overlaps:function(a){return a.x+a.w>this.x&&a.y+a.h>this.y&&a.x<this.x+this.w&&a.y<this.y+this.h},containsCoord:function(a,
b){return a>=this.x&&a<this.x+this.w&&b>=this.y&&b<this.y+this.h},show:function(){this.visible=!0},hide:function(){this.visible=!1},toggle:function(a){this.visible=a!==q?!!a:!this.visible}};E(t,l);t.prototype.setTitle=function(a){this.title=a};t.prototype.addButton=function(a){this.buttons.push(a);return a};t.prototype.draw=function(a,b,c){if(this.visible){this.setCoords(0,0,b,c);a.fillStyle="rgba(0,0,0,0.8)";a.fillRect(0,0,b,c);var e=this.buttons.length+1,f=.8*b,d=Math.min(.1*c,.7*c/e),h=.3*d;e=
e*d+(e-1)*h;b=b/2-f/2;J(a,b+f/2,c/2-e/2+d/2,.66*d,"helvetica,arial","#fff",this.title);for(var k=0;k<this.buttons.length;k++)this.buttons[k].draw(a,b,c/2-e/2+(k+1)*(d+h),f,d)}};t.prototype.click=function(a,b){ia(this.buttons,a,b)};E(x,l);x.prototype.setColors=function(a,b){this.fontColor=a;this.backgroundColor=b};x.prototype.draw=function(a,b,c,e,f){this.visible&&(this.setCoords(b,c,e,f),a.fillStyle=this.backgroundColor,y(a,b,c,e,f,f/10),J(a,b+e/2,c+f/2,.4*f,"helvetica, arial",this.fontColor,this.text))};
x.prototype.click=function(a,b){this.callback(this)};E(v,l);v.prototype.clear=function(){for(var a=0;a<this.cards.length;a++)this.cards[a].spinAway();this.finishedCards=this.cards;this.cards=[];this.cardHashes={}};v.prototype.populate=function(a){var b=1,c=Infinity,e=this.game.getTargetDifficulty();"hard"===e?c=5:"medium"===e?(b=6,c=8):b=9;e=[];for(var f=0;16>f;f++)(!this.cards[f]||a&&this.cards[f].accepted)&&e.push(f);a=0;do{for(f=0;f<e.length;f++){var d=e[f];this.cards[d]&&(this.cardHashes[this.cards[d].uniqueHash()]=
!1);for(var h=!1;!h;){var k=new r(n),g=k.uniqueHash();this.cardHashes[g]||(this.cards[d]=k,h=this.cardHashes[g]=!0)}}this._numValidSets=-1;f=this.numValidSets();a++}while((f<b||f>c)&&10>a)};v.prototype.solvable=function(){return 0<this.numValidSets(!0)};v.prototype.getActualDifficulty=function(){var a=this.numValidSets();return 5>=a?"hard":9>a?"medium":"easy"};v.prototype.numValidSets=function(a){if(-1!==this._numValidSets)return this._numValidSets;for(var b=0,c=0;c<this.cards.length;c++)for(var e=
0;e<this.cards.length;e++)if(e!==c)for(var f=0;f<this.cards.length;f++)if(f!==c&&f!==e&&this.isValidSet(this.cards[c],this.cards[e],this.cards[f])&&(b++,a))return b;return b/6};v.prototype.isValidSet=function(a,b,c){return(a.colorNum===b.colorNum&&b.colorNum===c.colorNum||a.colorNum!==b.colorNum&&b.colorNum!==c.colorNum&&a.colorNum!==c.colorNum)&&(a.shapeNum===b.shapeNum&&b.shapeNum===c.shapeNum||a.shapeNum!==b.shapeNum&&b.shapeNum!==c.shapeNum&&a.shapeNum!==c.shapeNum)&&(a.patternNum===b.patternNum&&
b.patternNum===c.patternNum||a.patternNum!==b.patternNum&&b.patternNum!==c.patternNum&&a.patternNum!==c.patternNum)&&(a.countNum===b.countNum&&b.countNum===c.countNum||a.countNum!==b.countNum&&b.countNum!==c.countNum&&a.countNum!==c.countNum)?!0:!1};v.prototype.draw=function(a,b,c,e,f){this.setCoords(b,c,e,f);a.fillStyle="#554f4f";y(a,b,c,e,f,10);var d=e/20;z(a,b+d/2,c+d/2,d);z(a,b+e-d/2,c+d/2,d);z(a,b+d/2,c+f-d/2,d);z(a,b+e-d/2,c+f-d/2,d);if(e/f>K){var h=.21*f;d=h*K}else d=.21*e,h=d/K;var k=(e-4*
d)/2/3;e=(e-4*d-3*k)/2;f=(f-4*h-3*k)/2;for(var g=0;g<this.cards.length;g++)this.cards[g].setCoords(b+e+g%4*(d+k),c+f+(g/4>>0)*(h+k),d,h),this.cards[g].draw(a);for(b=this.finishedCards.length-1;0<=b;b--)c=this.finishedCards[b],0!==c.w&&(c.updateMotion(),c.draw(a)),this.overlaps(c)||this.finishedCards.splice(b,1)};v.prototype.click=function(a,b){for(var c=!1,e=this.cards.length-1;0<=e;e--)c=this.cards[e].click(a,b)||c;a=[];for(b=0;b<this.cards.length;b++)this.cards[b].selected&&a.push(this.cards[b]);
if(3===a.length)if(this.isValidSet(a[0],a[1],a[2])){a.forEach(function(a){a.accepted=!0});n.addSuccess();c=n.checkWin();for(b=0;b<a.length;b++)a[b].spinAway();this.finishedCards=a;n.isGroup&&(n.isGroupHost?(n.incrementHostSuccess(),c?this.clear():this.populate(!0),n.broadcastGameState()):n.reportSuccess(a.map(function(a){return a.uniqueHash()})));if(!n.isGroup||n.isGroupHost)c?this.clear():this.populate(!0)}else{for(c=0;c<a.length;c++)a[c].selected=!1;n.addFailure();n.isGroup&&(n.isGroupHost?(n.incrementHostFailure(),
n.broadcastGameState()):n.reportFailure())}else c&&n.playSound(800,1)};v.prototype.acceptClientSet=function(a){for(var b=0;b<a.length;b++)a[b].accepted=!0,a[b].spinAway();this.finishedCards=a;this.populate(!0)};v.prototype.serialize=function(){return{cards:this.cards.map(function(a){return a.serialize()})}};v.prototype.load=function(a){var b={};this.cards.forEach(function(a){b[a.uniqueHash()]=a});a=a.cards;for(var c=[],e=0;e<a.length;e++){var f=new r(n);f.load(a[e]);var d=f.uniqueHash(),h=b[d];h?
(delete b[d],c.push(h)):c.push(f)}this.cards=c;this.cardHashes={};for(a=0;a<this.cards.length;a++)this.cardHashes[this.cards[a].uniqueHash()]=!0;this.finishedCards=Object.values(b);this.finishedCards.forEach(function(a){a.spinAway()})};var A=[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]];E(r,l);var P=["#90f","#f70","#07f"];r.prototype.setCardConfig=function(a){this.colorNum=a.colorNum;this.shapeNum=a.shapeNum;this.patternNum=a.patternNum;this.countNum=a.countNum;this.perturbCoords=[];if(0===this.shapeNum)for(a=
0;a<A.length;a++)this.perturbCoords.push([0,0])};r.prototype.uniqueHash=function(){return""+this.colorNum+this.shapeNum+this.patternNum+this.countNum};r.prototype.spinAway=function(){this.lastPositionUpdateTime=Date.now();var a=15*this.w,b=Math.random()*Math.PI*2;this.xVelocity=Math.sin(b)*a;this.yVelocity=Math.cos(b)*a;this.rotationVelocity=6*Math.PI};r.prototype.draw=function(a){var b=this.x,c=this.y,e=this.w,f=this.h,d=(Date.now()-this.initTime)%1E3;this.animationPercent=(500<d?1E3-d:d)/500;a.save();
this.rotation&&(a.translate(b+e/2,c+f/2),a.rotate(this.rotation),b-=b+e/2,c-=c+f/2);d=e/20;if(this.selected){a.fillStyle="#90f";var h=e/15;y(a,b-h,c-h,e+2*h,f+2*h,d);a.fillStyle="#f70";h=this.animationPercent*e/15;y(a,b-h,c-h,e+2*h,f+2*h,d)}a.fillStyle="#fff";y(a,b,c,e,f,d);if(0===this.shapeNum){d=this.perturbCoords;h=.01*e;for(var k=0;k<d.length;k++)d[k][0]+=Math.random()*h/2*2-h/2,d[k][1]+=Math.random()*h/2*2-h/2,d[k][0]=Math.min(A[k][0]+h,Math.max(A[k][0]-h,d[k][0])),d[k][1]=Math.min(A[k][1]+h,
Math.max(A[k][1]-h,d[k][1]));this.perturbCoords=d}d=.22*f;b=b+e/2-d/2;0===this.countNum?this.drawShape(a,b,c+.5*f-d/2,d,d):1===this.countNum?(this.drawShape(a,b,c+.33*f-d/2,d,d),this.drawShape(a,b,c+.66*f-d/2,d,d)):(this.drawShape(a,b,c+.2*f-d/2,d,d),this.drawShape(a,b,c+.5*f-d/2,d,d),this.drawShape(a,b,c+.8*f-d/2,d,d));a.restore()};r.prototype.drawShape=function(a,b,c,e,f){a.save();0===this.patternNum?(a.fillStyle=P[this.colorNum],a.strokeStyle="none"):(1===this.patternNum?(a.fillStyle="none",a.lineWidth=
e/15):(a.fillStyle="none",a.lineWidth=e/9),a.strokeStyle=P[this.colorNum],b+=a.lineWidth/2,c+=a.lineWidth/2,e-=a.lineWidth,f-=a.lineWidth);if(0===this.shapeNum){for(var d=[[b,c],[b+.5*e,c],[b+e,c],[b+e,c+.5*f],[b+e,c+f],[b+.5*e,c+f],[b,c+f],[b,c+.5*f]],h=0;h<this.perturbCoords.length;h++)d[h][0]+=this.perturbCoords[h][0],d[h][1]+=this.perturbCoords[h][1];h=[1];1===this.patternNum&&(h=[1,.66,.33]);for(var k=0;k<h.length;k++){a.beginPath();a.moveTo((d[0][0]-(b+e/2))*h[k]+(b+e/2),(d[0][1]-(c+f/2))*h[k]+
(c+f/2));for(var g=1;g<d.length;g++)a.lineTo((d[g][0]-(b+e/2))*h[k]+(b+e/2),(d[g][1]-(c+f/2))*h[k]+(c+f/2));a.closePath();0===this.patternNum?a.fill():a.stroke()}}else if(1===this.shapeNum)d=e/2*(.9+.2*this.animationPercent),0===this.patternNum?z(a,b+e/2,c+f/2,d):(G(a,b+e/2,c+f/2,d),1===this.patternNum&&(G(a,b+e/2,c+f/2,.66*d),G(a,b+e/2,c+f/2,.33*d)));else for(d=f*Math.sqrt(3)/2,h=[1],1===this.patternNum&&(h=[1,.5,.04]),k=0;k<h.length;k++){g=e*h[k];var m=f*h[k],p=b+(e-g)/2,l=c+(f-m)/2,n=m*Math.sqrt(3)/
2;a.save();a.translate(p+g/2,l+m/2+.15*d);a.rotate(this.animationPercent*Math.PI/8-Math.PI/16);a.beginPath();a.moveTo(0,.65*-n);a.lineTo(g/2,.35*n);a.lineTo(-g/2,.35*n);a.closePath();0===this.patternNum?a.fill():a.stroke();a.restore()}a.restore()};r.prototype.click=function(a,b){return a>=this.x&&a<this.x+this.w&&b>=this.y&&b<this.y+this.h?(this.selected=!this.selected,!0):!1};r.prototype.serialize=function(){return[this.colorNum,this.shapeNum,this.patternNum,this.countNum]};r.prototype.load=function(a){this.setCardConfig({colorNum:a[0],
shapeNum:a[1],patternNum:a[2],countNum:a[3]})};var K=5/7,n=new function(){var a=this,b=m.getElementById("game-canvas"),c=b.getContext("2d"),e=g.AudioContext||g.webkitAudioContext,f,d,h=1,k,l,n={easy:"#4b4",medium:"#aa0",hard:"#f44"},p=new v(this),u=new t(this,""),q=new t(this,"You Lose."),r=new t(this,"You Won!"),z=new t(this,""),A,E,T,U,B=0,L,G,Q=0,C=!1,K=0,V,Z,aa,D=0,F=0,M=0,ba=!0,R=!1;this.isGroupHost=this.isGroup=!1;var H,S=[],ca,N,w={},O=[],da=function(){.1>Math.abs(g.innerWidth/g.innerHeight-
.625)?(f=g.innerWidth,d=g.innerHeight):.625<g.innerWidth/g.innerHeight?(d=g.innerHeight,f=.625*d):(f=g.innerWidth,d=f/.625);b.style.width=f+"px";b.style.height=d+"px";b.width=f*h;b.height=d*h},P=function(){V=Date.now();0===K%10&&(aa=Z,Z=V);!C&&9E4<V-L-Q&&(I(),p.clear(),q.show(),ea(100,2));a.draw();K++;g.requestAnimationFrame(P)},I=function(){C?(Q=a.isGroup?0:Q+(Date.now()-G),C=!1):(G=Date.now(),C=!0)},ea=function(a,b){if(ba&&k){b=b||.5;var c=k.createOscillator(),d=k.createGain();c.connect(d);d.connect(k.destination);
c.frequency.value=a;c.type="triangle";c.start(0);d.gain.value=.01;d.gain.exponentialRampToValueAtTime(1,k.currentTime+.05);d.gain.exponentialRampToValueAtTime(1E-5,k.currentTime+b);c.stop(k.currentTime+2*b)}};this.playSound=ea;var W=function(a,b,c){var d=0,e=function(){ea(a[d],b);d++;d<a.length&&setTimeout(e,1E3*c)};e()},fa=function(){if(R)R=!1,A.text="Enable Music",l.gain.exponentialRampToValueAtTime(.2,k.currentTime),l.gain.exponentialRampToValueAtTime(1E-5,k.currentTime+.05);else if(R=!0,A.text=
"Disable Music",l)l.gain.exponentialRampToValueAtTime(.2,k.currentTime+.05);else if(k){var a=k.createOscillator();l=k.createGain();a.connect(l);l.connect(k.destination);a.type="triangle";l.gain.value=.01;a.start(0);l.gain.exponentialRampToValueAtTime(.2,k.currentTime+.05);for(var b=[200,250,300,400],c=[.5,.25],d=0,e;3600>d;){var f=b[Math.random()*b.length>>0];if(f!==e){e=f;var g=c[Math.random()*c.length>>0];a.frequency.setValueAtTime(f,k.currentTime+d);d+=g}}l.gain.setValueAtTime(.2,k.currentTime+
d);l.gain.exponentialRampToValueAtTime(1E-5,k.currentTime+d+1)}};this.addSuccess=function(){D++;a.playSuccessSound()};this.playSuccessSound=function(){W([800,1200,1600],.5,.1)};this.checkWin=function(){return D-F>=M?(I(),a.isGroup&&(a.isGroupHost?(T.text="Start Level "+(B+1),T.show()):T.hide()),r.show(),!0):!1};this.getTargetDifficulty=function(){var a=(D-F)/M;return a>=2/3?"hard":a>=1/3?"medium":"easy"};this.addFailure=function(){F++;a.playFailureSound()};this.playFailureSound=function(){W([900,
600,400],.5,.1)};this.incrementHostFailure=function(){var b=w[H.id];b&&b.failure++;a.broadcastLog(b.name+" messed up");a.drawGroupPanel()};this.incrementHostSuccess=function(){var b=w[H.id];b&&b.success++;a.broadcastLog(b.name+" found a set");a.drawGroupPanel()};this.draw=function(){c.save();c.fillStyle="#9855ff";c.fillRect(0,0,b.width,b.height);c.restore();var a=.1*b.height,d=b.width,e=b.height-a,f=.03*d;d-=2*f;var g=e-a;p.draw(c,(b.width-d)/2,b.height-g-f,d,g);g=p.numValidSets();var h=p.getActualDifficulty();
f=n[h];g="board contains "+g+" set"+(1===g?"":"s")+" ("+h.toUpperCase()+")";y(c,p.x+.2*d,a+.023*e,.6*d,.05*e,.07*a);J(c,p.x+d/2,a+.05*e,.2*a,"arial",f,g);U.draw(c,p.x,.25*a,.2*d,.5*a);c.fillStyle="#554f4f";y(c,p.x+.3*d,.15*a,.4*d,.7*a,.07*a);J(c,p.x+d/2,.33*a,.2*a,"arial","#fff","Level "+B);J(c,p.x+d/2,.66*a,.3*a,"arial","#fff",D-F+" / "+M+" sets");aa&&(e=Math.round(1E4/(Z-aa)),c.fillStyle="#9855ff",y(c,p.x+.8*d,.4*a,.2*d,.4*a),J(c,p.x+.9*d,.5*a,.2*a,"monospace","#fff",e+" fps"));e=.4*d;f=a/20;d=
p.x+.3*d;a-=(.15*a-f)/2;c.fillStyle="#554f4f";y(c,d,a,e,f,f/2);c.fillStyle="#fff";y(c,d,a,Math.max(0,90-((C?G:V)-L-Q)/1E3)/90*e,f,f/2);u.draw(c,b.width,b.height);z.draw(c,b.width,b.height);q.draw(c,b.width,b.height);r.draw(c,b.width,b.height)};var ha=m.getElementById("group-panel");this.drawGroupPanel=function(){ha.style.display="block";var a='\n\t\t<div class="group-scores">\n\t\t\t<h2>Scores</h2>\n\t\t\t'+Object.values(w).sort(function(a,b){return b.success-b.failure-(a.success-a.failure)}).map(function(a){return'\n\t\t\t\t<div class="group-player">\n\t\t\t\t\t<div class="group-player-name">'+
a.name+'</div>\n\t\t\t\t\t<div class="group-player-success">'+a.success+'</div>\n\t\t\t\t\t<div class="group-player-failure">'+a.failure+"</div>\n\t\t\t\t</div>\n\t\t\t\t"}).join("")+'\n\t\t</div>\n\t\t<div class="group-logs">\n\t\t\t'+O.map(function(a){return'<div class="group-log">'+a+"</div>"}).reverse().join("")+"\n\t\t</div>\n\t\t";ha.innerHTML=a};this.hideGroupPanel=function(){ha.style.display="none"};var ja=function(){return{type:"state",level:B,pointsNeeded:M,levelStartTime:L,successCount:D,
failureCount:F,players:w,board:p.serialize()}};this.broadcastGameState=function(){var a=ja();S.forEach(function(b){b.send(a)})};this.broadcastLog=function(b){a.appendGroupLog(b);S.forEach(function(a){a.send({type:"log",msg:b})})};this.reportSuccess=function(a){console.debug("Sent success to host");N.send({type:"success",set:a})};this.reportFailure=function(){console.debug("Sent failure to host");N.send({type:"failure"})};this.resetGroupScores=function(){Object.values(w).forEach(function(a){a.success=
0;a.failure=0})};this.appendGroupLog=function(b){O.push(b);30<O.length&&(O=O.slice(O.length-30));a.drawGroupPanel()};var X=function(){W([400,600,900,1350,900,600,400],.5,.1)},ka=function(){B++;L=Date.now();Q=0;C=!1;F=D=0;M=B;p.clear();p.populate();X()},Y=function(){B=0;E.show();u.setTitle("Game Paused");ka()};(function(){da();g.addEventListener("resize",da);var c=/room=(\w+)/.exec(g.location.search||""),l=c?c[1]:null,n=!1,t=!1;m.addEventListener("visibilitychange",function(){m.hidden?(C||(I(),n=!0),
R&&(fa(),t=!0)):(C&&n&&I(),!R&&t&&fa(),t=n=!1)});m.addEventListener("keyup",function(a){k||(k=new e);"Escape"!==a.key||!B||r.visible||q.visible||(I(),u.toggle())});m.addEventListener("click",function(a){k||(k=new e);ia([U,p,u,q,r],(a.clientX-(g.innerWidth-f)/2)/f*b.width,a.clientY/d*b.height)});U=new x(a,"Menu",function(){I();u.toggle()});U.setColors("#fff","#554f4f");u.addButton(new x(a,"New Solo Game",function(){a.isGroup=!1;a.isGroupHost=!1;Y();u.hide()}));u.addButton(new x(a,"New Group Game",
function(b){var c=prompt("Please enter a username").substring(0,30);a.resetGroupScores();b.text="Creating room...";a.isGroup=!0;a.isGroupHost=!0;H=new Peer;H.on("open",function(b){history.replaceState(null,"Group Game","?room="+b);Y();u.hide();a.broadcastLog(c+" started the game");w[b]={success:0,failure:0,name:c};a.drawGroupPanel()});H.on("connection",function(b){console.debug("Received connection from peer "+b.peer);b.on("data",function(c){var d=w[b.peer];if(d){if("failure"===c.type)a.addFailure(),
d.failure++,a.broadcastLog(d.name+" messed up"),a.drawGroupPanel(),a.broadcastGameState();else if("success"===c.type){var e=c.set,f={};p.cards.forEach(function(a){f[a.uniqueHash()]=a});var g=[];e.forEach(function(a){(a=f[a])&&g.push(a)});3===g.length&&p.isValidSet(g[0],g[1],g[2])&&(p.acceptClientSet(g),d.success++,a.broadcastLog(d.name+" found a set"),a.drawGroupPanel(),a.addSuccess(),a.checkWin()&&p.clear());a.broadcastGameState()}console.debug("Received from client",c)}});b.on("open",function(){S.push(b);
var c=b.metadata;a.broadcastLog(c.username+" joined the game");w[b.peer]||(w[b.peer]={success:0,failure:0,name:c.username});a.drawGroupPanel();b.send(ja())});b.on("close",function(){var c=w[b.peer];S=S.filter(function(a){return a.peer===b.peer});a.broadcastLog(c.name+" left the game");w[b.peer]&&delete w[b.peer];a.drawGroupPanel()});b.on("error",function(c){a.broadcastLog(w[b.peer].name+" had an error");a.drawGroupPanel()})});H.on("disconnected",function(){console.debug("Host peer disconnected")});
H.on("error",function(a){console.error("Host peer error",a)})}));u.addButton(new x(a,"Disable Sound Effects",function(a){"Disable Sound Effects"===a.text?(ba=!1,a.text="Enable Sound Effects"):(ba=!0,a.text="Disable Sound Effects",W([800,1200,1600],.5,.1))}));A=u.addButton(new x(a,"Enable Music",fa));u.addButton(new x(a,"Resolution: 1X",function(a){h*=2;4<h&&(h=.25);da();a.text="Resolution: "+h+"X"}));E=u.addButton(new x(a,"Cancel",function(){I();u.hide()}));q.addButton(new x(a,"New Game",function(){Y();
q.hide();X();a.isGroup&&(a.resetGroupScores(),a.isGroupHost&&a.broadcastGameState())}));T=r.addButton(new x(a,"Start Next Level",function(){r.hide();ka();a.isGroupHost&&(a.broadcastGameState(),a.broadcastLog("Starting level "+B))}));P();E.hide();u.setTitle("Combo Shapes");z.setTitle("Joining room...");if(l){var v=prompt("Please enter a username").substring(0,30);a.isGroup=!0;a.isGroupHost=!1;var y=!0;z.show();ca=new Peer;ca.on("open",function(b){N=ca.connect(l,{metadata:{username:v}});N.on("open",
function(){N.send("Hello, I am client peer "+b)});N.on("data",function(b){console.debug("Received from host",b);"state"===b.type?(y&&(Y(),u.hide(),X(),p.clear(),z.hide()),y=!1,b.failureCount>F&&a.playFailureSound(),b.successCount>D&&a.playSuccessSound(),b.levelStartTime!==L?(q.hide(),r.hide(),C=!1,X()):b.successCount<D&&a.playFailureSound(),B=b.level,M=b.pointsNeeded,L=b.levelStartTime,D=b.successCount,F=b.failureCount,w=b.players,p.load(b.board),a.drawGroupPanel(),a.checkWin()&&p.clear()):"log"===
b.type&&a.appendGroupLog(b.msg)})})}else u.show()})()};m.getElementById("game-canvas").addEventListener("click",function(){m.getElementById("game-description").style.display="none"})})(window,document,void 0);
